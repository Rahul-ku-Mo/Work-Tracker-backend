generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                   @id @default(uuid())
  email                    String                   @unique
  password                 String?
  name                     String?
  username                 String?                  @unique
  imageUrl                 String?
  createdAt                DateTime                 @default(now())
  phoneNumber              String?
  state                    String?
  address                  String?
  zipCode                  String?
  company                  String?
  department               String?
  isPaidUser               Boolean?                 @default(false)
  isActive                 Boolean?                 @default(true)
  role                     AppRole                  @default(USER)
  updatedAt                DateTime                 @updatedAt
  paddleCustomerId         String?                  @unique
  teamId                   String?
  efficiency               Int?
  AiConversation           AiConversation[]
  Workspace                Workspace[]
  sentWorkspaceInvitations WorkspaceInvitation[]    @relation("WorkspaceInvitationSender")
  workspaces               WorkspaceUser[]
  createdCards             Card[]                   @relation("cardCreator")
  comments                 Comment[]
  imageUploads             ImageUpload[]            @relation("ImageUploads")
  notes                    Note[]                   @relation("UserNotes")
  noteCategories           NoteCategory[]           @relation("UserNoteCategories")
  receivedNotification     Notification[]           @relation("receiver")
  sentNotification         Notification[]           @relation("sender")
  performanceMetrics       PerformanceMetric[]      @relation("userMetrics")
  projects                 Project[]                @relation("UserProjects")
  projectsLed              Project[]                @relation("ProjectLead")
  projectsMember           ProjectMember[]
  captainOf                Team?                    @relation("TeamCaptain")
  timeEntries              TimeEntry[]
  team                     Team?                    @relation("TeamMembers", fields: [teamId], references: [id])
  performanceHistory       UserPerformanceHistory[] @relation("userPerformanceHistory")
  subscription             Subscription?
  assignedCards            Card[]                   @relation("assignee")
  mentions  Mention[]
}

model Team {
  id                   String                    @id @default(uuid())
  name                 String
  joinCode             String?                   @unique
  captainId            String                    @unique
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  teamImageUrl         String?
  performanceMetrics   PerformanceMetric[]       @relation("teamMetrics")
  projects             Project[]                 @relation("TeamProjects")
  sprints              Sprint[]
  captain              User                      @relation("TeamCaptain", fields: [captainId], references: [id])
  performanceSnapshots TeamPerformanceSnapshot[] @relation("teamSnapshots")
  members              User[]                    @relation("TeamMembers")
}

model Workspace {
  id          Int                   @id @default(autoincrement())
  title       String
  slug        String               @unique
  userId      String
  colorId     String
  colorValue  String
  colorName   String
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  invitations WorkspaceInvitation[]
  members     WorkspaceUser[]
  columns     Column[]
  projects    ProjectWorkspace[]
  sprints     Sprint[]
}

model WorkspaceUser {
  id          String        @id @default(uuid())
  workspaceId Int
  userId      String
  role        WorkspaceRole @default(MEMBER)
  isFavorite  Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
}

model WorkspaceInvitation {
  id          String        @id @default(uuid())
  email       String
  workspaceId Int
  role        WorkspaceRole @default(MEMBER)
  token       String        @unique
  invitedBy   String
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  inviter     User          @relation("WorkspaceInvitationSender", fields: [invitedBy], references: [id])

  @@index([email])
  @@index([token])
}

model Column {
  id          Int       @id @default(autoincrement())
  order       Int
  title       String
  workspaceId Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  cards       Card[]
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model Project {
  id          String             @id @default(uuid())
  title       String
  slug        String             @unique
  summary     String?
  description String?
  startDate   DateTime?
  targetDate  DateTime?
  milestones  Json[]
  priority    String?
  status      String             @default("Not Started")
  teamId      String
  leadId      String?
  creatorId   String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  cards       Card[]
  creator     User               @relation("UserProjects", fields: [creatorId], references: [id], onDelete: Cascade)
  lead        User?              @relation("ProjectLead", fields: [leadId], references: [id])
  team        Team               @relation("TeamProjects", fields: [teamId], references: [id], onDelete: Cascade)
  workspaces  ProjectWorkspace[]
  members     ProjectMember[]

  @@index([teamId])
  @@index([leadId])
  @@index([creatorId])
}

model ProjectMember {
  id        String      @id @default(uuid())
  projectId String
  userId    String
  role      ProjectRole @default(MEMBER)
  joinedAt  DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

model Card {
  id             Int         @id @default(autoincrement())
  title          String
  slug           String?     @unique
  order          Int
  description    String?
  columnId       Int
  projectId      String?
  labels         String[]
  attachments    String[]
  priority       String?
  storyPoints    Int?        @default(0)
  createdAt      DateTime    @default(now())
  dueDate        DateTime?
  updatedAt      DateTime    @updatedAt
  creatorId      String?
  estimatedHours Float?
  actualHours    Float?
  completedAt    DateTime?
  isOnTime       Boolean?
  sprintId       String?
  column         Column      @relation(fields: [columnId], references: [id], onDelete: Cascade)
  creator        User?       @relation("cardCreator", fields: [creatorId], references: [id])
  project        Project?    @relation(fields: [projectId], references: [id])
  sprint         Sprint?     @relation(fields: [sprintId], references: [id])
  comments       Comment[]
  timeEntries    TimeEntry[]
  tags           Tag[]       @relation("CardToTag")
  assignees      User[]      @relation("assignee")

  @@index([sprintId])
  @@index([projectId])
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  cardId    Int
  userId    String
  createdAt DateTime @default(now())
  card      Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id           Int      @id @default(autoincrement())
  senderId     String
  receiverId   String
  message      Message
  metadata     String?
  isRead       Boolean  @default(false)
  readAt       DateTime?
  type         String?  // 'mention', 'card_assigned', etc.
  title        String?
  contentType  String?  // 'task', 'project', 'note'
  contentId    String?  // ID of the content being referenced
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  receiver     User     @relation("receiver", fields: [receiverId], references: [id])
  sender       User     @relation("sender", fields: [senderId], references: [id])

  @@index([receiverId])
  @@index([isRead])
  @@index([type])
  @@index([contentType, contentId])
}

model AiConversation {
  id        String                  @id @default(uuid())
  userId    String
  title     String
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt
  user      User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  AiConversationMessage[]
}

model AiConversationMessage {
  id               String         @id @default(uuid())
  content          String
  aiConversationId String
  role             String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  aiConversation   AiConversation @relation(fields: [aiConversationId], references: [id], onDelete: Cascade)
}

model Sprint {
  id                   String                    @id @default(uuid())
  name                 String
  startDate            DateTime
  endDate              DateTime
  plannedPoints        Float
  teamId               String
  workspaceId          Int
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  completedPoints      Float?
  efficiency           Float?
  cards                Card[]
  performanceMetrics   PerformanceMetric[]       @relation("sprintMetrics")
  workspace            Workspace                 @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  team                 Team                      @relation(fields: [teamId], references: [id])
  performanceSnapshots TeamPerformanceSnapshot[]

  @@index([teamId])
  @@index([workspaceId])
}

model TimeEntry {
  id             String    @id @default(uuid())
  userId         String
  cardId         Int
  startTime      DateTime
  endTime        DateTime?
  lastResumeTime DateTime?
  totalDuration  Int       @default(0)
  isPaused       Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  card           Card      @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([cardId])
}

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cards     Card[]   @relation("CardToTag")
}

model PerformanceMetric {
  id            String     @id @default(uuid())
  date          DateTime
  metricType    MetricType
  value         Float
  target        Float?
  previousValue Float?
  notes         String?
  userId        String?
  teamId        String?
  sprintId      String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  sprint        Sprint?    @relation("sprintMetrics", fields: [sprintId], references: [id])
  team          Team?      @relation("teamMetrics", fields: [teamId], references: [id])
  user          User?      @relation("userMetrics", fields: [userId], references: [id])

  @@index([userId])
  @@index([teamId])
  @@index([sprintId])
  @@index([date])
  @@index([metricType])
}

model TeamPerformanceSnapshot {
  id         String   @id @default(uuid())
  teamId     String
  date       DateTime
  velocity   Float
  efficiency Float
  createdAt  DateTime @default(now())
  team       Team     @relation("teamSnapshots", fields: [teamId], references: [id])
  sprint     Sprint?  @relation(fields: [sprintId], references: [id])
  sprintId   String?

  @@index([teamId])
  @@index([date])
}

model UserPerformanceHistory {
  id         String   @id @default(uuid())
  userId     String
  date       DateTime
  efficiency Int
  velocity   Float
  createdAt  DateTime @default(now())
  user       User     @relation("userPerformanceHistory", fields: [userId], references: [id])

  @@index([userId])
  @@index([date])
}

model Subscription {
  id                   String           @id @default(uuid())
  userId               String           @unique
  plan                 SubscriptionPlan
  status               String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  paddleSubscriptionId String?          @unique
  cancelAtPeriodEnd    Boolean          @default(false)
  user                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([paddleSubscriptionId])
  @@map("subscriptions")
}

model ImageUpload {
  id        String   @id @default(uuid())
  userId    String
  s3Key     String
  fileName  String
  fileSize  Int
  mimeType  String
  url       String
  createdAt DateTime @default(now())
  user      User     @relation("ImageUploads", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model NoteCategory {
  id         String   @id @default(uuid())
  name       String
  slug       String
  hoverColor String?
  userId     String
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  notes      Note[]
  user       User     @relation("UserNoteCategories", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
  @@index([slug])
}

model Note {
  id          String       @id @default(uuid())
  title       String
  content     String
  categoryId  String
  userId      String
  icon        String?
  iconColor   String?
  emoji       String?
  isCompleted Boolean      @default(false)
  isPublic    Boolean      @default(false)
  priority    Int?
  tags        String[]
  coverType   String?
  coverValue  String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  category    NoteCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user        User         @relation("UserNotes", fields: [userId], references: [id], onDelete: Cascade)


  @@index([categoryId])
  @@index([userId])
  @@index([createdAt])
  @@index([isPublic])
}

model ProjectWorkspace {
  id          String    @id @default(uuid())
  projectId   String
  workspaceId Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, workspaceId])
  @@index([projectId])
  @@index([workspaceId])
}

model Mention {
  id           String   @id @default(cuid())
  mentionedId  String   // User being mentioned
  contentType  String   // "task", "project", "note"
  contentId    String   // ID of task or project (as string)
  createdAt    DateTime @default(now())

  // Relations
  mentionedUser User @relation(fields: [mentionedId], references: [id], onDelete: Cascade)

  @@unique([mentionedId, contentType, contentId])
  @@index([contentType, contentId])
  @@index([contentId])
  @@map("mentions")
}

enum AppRole {
  ADMIN
  USER
}

enum WorkspaceRole {
  ADMIN
  MEMBER
}

enum ProjectRole {
  LEAD
  MEMBER
  OBSERVER
}

enum Message {
  JOIN
  LEAVE
  CARD_ASSIGNED
  CARD_UPDATED
  CARD_COMPLETED
  CARD_COMMENTED
  CARD_DUE_SOON
  CARD_OVERDUE
  MENTION
}

enum MetricType {
  VELOCITY
  COMPLETION_RATE
  AVERAGE_TIME
  EFFICIENCY
  PLANNING_ACCURACY
  REVIEW_EFFICIENCY
  TIME_DISTRIBUTION
  PEAK_PERFORMANCE
  TEAM_VELOCITY
  BURNDOWN_RATE
  COLLABORATION_SCORE
}

enum SubscriptionPlan {
  FREE
  PRO
  TEAM
  ENTERPRISE
}
